# Claude Code Shorthand Lab - Development Container
# ……ふふ、この中でClaude Codeと遊べるの

FROM node:20-slim

# 基本ツールのインストール
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    vim \
    bash \
    ca-certificates \
    sudo \
    gosu \
    && rm -rf /var/lib/apt/lists/*

# 作業ディレクトリ
WORKDIR /workspace

# nodeユーザーを削除して、developerユーザーを作成
# node:20-slimにはUID 1000のnodeユーザーが存在する
RUN userdel -r node 2>/dev/null || true
RUN useradd -u 1000 -m -s /bin/bash developer && \
    echo "developer ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Node.js のグローバルパッケージ
RUN npm install -g \
    pnpm@latest \
    typescript@latest \
    vitest@latest

# zero-cc インストーラーで Claude Code + ccd-glm をセットアップ
# developerユーザーでインストール
USER developer
RUN curl -fsSL https://raw.githubusercontent.com/Sunwood-AI-OSS-Hub/zero-cc/refs/heads/main/script/install.sh | bash

# .bashrc.d を non-interactive でも読み込むように修正
# 1. .bashrcの末尾にあるzero-ccが追加した部分を削除
# 2. .bashrcの先頭に追加
RUN grep -v "user snippets (modular)" ~/.bashrc > ~/.bashrc.tmp && \
mv ~/.bashrc.tmp ~/.bashrc && \
printf '# ---- user snippets (modular) -- always load ----\n\
if [ -d "$HOME/.bashrc.d" ]; then\n\
  for f in "$HOME/.bashrc.d/"*.sh; do\n\
    [ -e "$f" ] && . "$f"\n\
  done\n\
fi\n\
\n' > ~/.bashrc.new && \
cat ~/.bashrc >> ~/.bashrc.new && \
mv ~/.bashrc.new ~/.bashrc

# 00-llm-secrets.shを環境変数から読み取るように修正
RUN sed -i 's/ZAI_API_KEY="YOUR_ZAI_API_KEY"/ZAI_API_KEY="${ZAI_API_KEY:-}"/' ~/.bashrc.d/00-llm-secrets.sh

# CC_NONROOT_USERをdeveloperに修正
RUN sed -i 's/CC_NONROOT_USER="node"/CC_NONROOT_USER="developer"/' ~/.bashrc.d/00-llm-secrets.sh

USER root

# workspaceの所有権を変更
RUN chown -R developer:developer /workspace

# エントリーポイント
COPY docker/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["bash", "-l"]
